#!/bin/bash
#
# Pre-commit hook for Apex Assistant
# Runs automatically before each commit to catch common issues
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Check 1: Look for potential secrets in staged files
echo -n "  Checking for secrets... "
SECRETS_PATTERN='(ANTHROPIC_API_KEY|sk-ant-|password\s*=\s*["\x27][^"\x27]+["\x27]|api_key\s*=)'

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
    # Check each staged file for secrets
    FOUND_SECRETS=""
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            MATCH=$(grep -lE "$SECRETS_PATTERN" "$file" 2>/dev/null)
            if [ -n "$MATCH" ]; then
                FOUND_SECRETS="$FOUND_SECRETS $file"
            fi
        fi
    done

    if [ -n "$FOUND_SECRETS" ]; then
        echo -e "${RED}FAILED${NC}"
        echo -e "${RED}Potential secrets found in:${NC}"
        for f in $FOUND_SECRETS; do
            echo "    - $f"
        done
        echo ""
        echo "If these are false positives, you can bypass with: git commit --no-verify"
        exit 1
    fi
fi
echo -e "${GREEN}OK${NC}"

# Check 2: Prevent committing .env files
echo -n "  Checking for .env files... "
ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env($|\.)')
if [ -n "$ENV_FILES" ]; then
    echo -e "${RED}FAILED${NC}"
    echo -e "${RED}Refusing to commit .env files:${NC}"
    echo "$ENV_FILES" | while read f; do echo "    - $f"; done
    echo ""
    echo "Remove them from staging with: git reset HEAD <file>"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# Check 3: Warn about large files (> 1MB)
echo -n "  Checking for large files... "
LARGE_FILES=""
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
        if [ "$SIZE" -gt 1048576 ]; then
            LARGE_FILES="$LARGE_FILES $file"
        fi
    fi
done

if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}Large files detected (>1MB):${NC}"
    for f in $LARGE_FILES; do
        SIZE=$(wc -c < "$f" | awk '{printf "%.1f", $1/1048576}')
        echo "    - $f (${SIZE}MB)"
    done
    echo ""
    echo "Consider adding to .gitignore if these shouldn't be tracked."
    # Just warn, don't block
fi

if [ -z "$LARGE_FILES" ]; then
    echo -e "${GREEN}OK${NC}"
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
