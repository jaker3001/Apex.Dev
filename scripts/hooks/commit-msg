#!/bin/bash
#
# Commit message hook for Apex Assistant
# Enforces conventional commit format for clear history
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Read the commit message
COMMIT_MSG=$(cat "$1")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge "; then
    exit 0
fi

# Conventional commit pattern
# Format: type(scope): description
# type is required, scope is optional
PATTERN='^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,}'

if ! echo "$COMMIT_MSG" | head -1 | grep -qE "$PATTERN"; then
    echo ""
    echo -e "${RED}Invalid commit message format!${NC}"
    echo ""
    echo -e "Your message: ${YELLOW}$(echo "$COMMIT_MSG" | head -1)${NC}"
    echo ""
    echo -e "${CYAN}Expected format:${NC} type(scope): description"
    echo ""
    echo -e "${CYAN}Valid types:${NC}"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  docs     - Documentation only"
    echo "  style    - Formatting, no code change"
    echo "  refactor - Code change that doesn't fix a bug or add feature"
    echo "  test     - Adding tests"
    echo "  chore    - Maintenance tasks"
    echo "  perf     - Performance improvement"
    echo "  ci       - CI/CD changes"
    echo "  build    - Build system changes"
    echo "  revert   - Revert a previous commit"
    echo ""
    echo -e "${CYAN}Examples:${NC}"
    echo "  feat: Add user authentication"
    echo "  fix(chat): Resolve message ordering bug"
    echo "  docs: Update API documentation"
    echo "  refactor(api): Simplify error handling"
    echo ""
    echo -e "To bypass this check: ${YELLOW}git commit --no-verify${NC}"
    echo ""
    exit 1
fi

# Check message length (first line should be < 72 chars for readability)
FIRST_LINE=$(echo "$COMMIT_MSG" | head -1)
if [ ${#FIRST_LINE} -gt 72 ]; then
    echo ""
    echo -e "${YELLOW}Warning: First line is ${#FIRST_LINE} characters (recommended: <72)${NC}"
    echo "Long commit messages are harder to read in git log."
    echo ""
    # Just warn, don't block
fi

exit 0
